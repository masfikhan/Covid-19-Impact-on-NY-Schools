<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>City Programs by District</title>
		<script type="text/javascript" src="../d3.js"></script>
		<link href='http://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="index.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
        <link href='http://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>	
		</style>
	</head>
	<body>
		<!-- Navigation menu -->
		<div class="navbar">
            <a href="index.html">Home</a>
            <a href="Borough_Covid.html">Borough COVID-19 Profiles</a>
            <a href="Broadband_Zipcode.html">Broadband Infrastructure</a>
            <a class="active" href="City_Programs.html">District COVID-19 Programs</a>
        </div>
        <h2 class="vis_heading">
            District COVID-19 Programs
        </h2>
		<br>
		<!-- Borough Buttons -->
		<div class="btn-group btn-group-toggle" data-toggle="buttons">
            <label class="btn btn-secondary">
                <input type="radio" name="borough" value="Queens">Queens<br>
            </label>
            <label class="btn btn-secondary">
                <input type="radio" name="borough" value="Brooklyn">Brooklyn<br>
            </label>
            <label class="btn btn-secondary">
                <input type="radio" name="borough" value="Manhattan">Manhattan<br>
            </label>
            <label class="btn btn-secondary">
                <input type="radio" name="borough" value="Bronx">Bronx<br>
            </label>
            <label class="btn btn-secondary">
                <input type="radio" name="borough" value="Staten Island">Staten Island<br>
            </label>
        </div>
        <br><br>
		<!-- Program Buttons -->
		<div class="btn-group btn-group-toggle" data-toggle="buttons">
            <label class="btn btn-secondary">
                <input type="radio" name="program_type" value="Meals">Meal Pick-Up Sites<br>
            </label>
            <label class="btn btn-secondary">
                <input type="radio" name="program_type" value="Tests">Covid-19 Testing Sites<br>
            </label>
        </div>
		<br><br>
        <p>
			In response to the health and economic problems generated by the pandemic, the city government established free meal pick-up locations, which ended in September 2020, and COVID-19 testing locations in public schools. <i>District COVID-19 Programs</i> shows economic disparities by school district and its relation to the city's distribution of resources, such as grab-and-go meals and testing sites. 
			The "Economic Need by School District" choropleth map encodes
			each school district with a color representing its economic need index. Based on the selected program type,
			you can see previous meal pick-up sites and active testing locations in each borough, and you can hover on
			a location marker to see the school name. You can also click on each school district to see additional contextual data:
			the "2019 NYS Test Score Percentages" bar chart shows the percentages of students who received Level 1 to Level 4
			scores in the 2019 ELA and Math state exams and the "Racial Makeup" donut chart shows the racial breakdown.
			<br><br>
			Buttons hovered-over are gray and buttons clicked-on are navy blue. Select a borough, then a program type
			to see the visualization.
		</p>
		<br>

		<script type="text/javascript">
            // properly format input from each row so that they are usable
			let my_rowConverter = function(d) {
				return {
					district:parseFloat(d['Administrative District']),
                    year:parseFloat(d['Year']),
                    asian:parseFloat(d['% Asian']),
                    black:parseFloat(d['% Black']),
                    hispanic:parseFloat(d['% Hispanic']),
                    multi_racial:parseFloat(d['% Multi-Racial']),
                    native_am:parseFloat(d['% Native American']),
                    white:parseFloat(d['% White']),
                    poverty:parseFloat(d['% Poverty']),
                    economic_need:parseFloat(d['Economic Need Index']),
				};
			}

            let mealConverter = function(d) {
				return {
					district:parseFloat(d['District']),
                    lon:parseFloat(d['Longitude']),
                    lat:parseFloat(d['Latitude']),
					school:String(d['SchoolName']),
					sfcode:parseFloat(d['SFCode'])
				};
			}

			let test_Converter = function(d) {
				return {
					school_name:String(d['Name']),
                    district:parseFloat(d['Admin District']),
				};
			}

			let school_locations_Converter = function(d) {
				return {
					school_name:String(d['location_name']),
					district:parseFloat(d['Administrative_District_Code']),
                    lon:parseFloat(d['LONGITUDE']),
					lat:parseFloat(d['LATITUDE']),
				};
			}

			let ela_test_Converter = function(d) {
				return {
					district:parseFloat(d['District']),
                    grade:String(d['Grade']),
                    year:parseFloat(d['Year']),
					category:String(d['Category']),
					level_1:parseFloat(d['ELA % Level 1']),
					level_2:parseFloat(d['ELA % Level 2']),
					level_3:parseFloat(d['ELA % Level 3']),
					level_4:parseFloat(d['ELA % Level 4']),

				};
			}

			let math_test_Converter = function(d) {
				return {
					district:parseFloat(d['District']),
                    grade:String(d['Grade']),
                    year:parseFloat(d['Year']),
					category:String(d['Category']),
					level_1:parseFloat(d['Math % Level 1']),
					level_2:parseFloat(d['Math % Level 2']),
					level_3:parseFloat(d['Math % Level 3']),
					level_4:parseFloat(d['Math % Level 4']),

				};
			}

			//Width and height
			let w = 2000;
			let h = 480;

			//Create SVG element
			let svg = d3.select("body")
				.append("svg")
				.attr("width", w)
				.attr("height", h);


			d3.csv("2020-2021_Demographic_Snapshot_District.csv", my_rowConverter).then((data)=> {

				//Load in GeoJSON data
				d3.json("districts.json").then(function(json) {

					// select borough
					d3.selectAll("input[name='borough']").on("change", function(){
						// remove previous text
						svg.selectAll(".borough").remove();
						svg.selectAll(".program").remove();
						svg.selectAll(".reminder").remove();

						// remove previous geo path for filtered borough
						svg.selectAll("path.a").remove();

						// remove pins
						svg.selectAll(".meal_sites_pin").remove();
						svg.selectAll(".testing_sites_pin").remove();

						// remove bar chart
						d3.select(".district").remove();
						svg.selectAll(".ela_scores").remove();
						svg.selectAll(".math_scores").remove();
						d3.select(".yaxis").remove();
						d3.select(".xaxis").remove();
						svg.selectAll(".score").remove();

						// remove arcs
						svg.selectAll(".arc1").remove();
						svg.selectAll(".race").remove();

						let selected_borough = this.value;

						// map text
						svg.append("text")
							.text("Economic Need by School District")
							.style("font-size", "28px")
							.attr("x", 20)
							.attr("fill", "white")
							.attr("font-family", "Lato Light")
							.attr("class", "borough")
							.attr("y", 40);

						svg.append("text")
							.text("Borough: " + selected_borough)
							.style("font-size", "18px")
							.attr("x", 20)
							.attr("fill", "white")
							.attr("font-family", "Lato Light")
							.attr("class", "borough")
							.attr("y", 80);

						svg.append("text")
							.text("Choose a program type")
							.style("font-size", "18px")
							.attr("x", 20)
							.attr("fill", "yellow")
							.attr("font-family", "Lato Light")
							.attr("class", "reminder")
							.attr("y", 110);

						// de-select radio buttons for access type
						var radio2 = document.getElementsByName("program_type");
						for(var i = 0; i < 2; i++)
						{
						    radio2[i].checked = false;
						}
						
						// select access type
						d3.selectAll("input[name='program_type']").on("change", function(){

							// remove elements of previous selection
							svg.selectAll(".meal_sites_pin").remove();
							svg.selectAll(".testing_sites_pin").remove();
							svg.selectAll(".reminder").remove();
							d3.select(".district").remove();
							svg.selectAll(".ela_scores").remove();
							svg.selectAll(".math_scores").remove();
							d3.select(".yaxis").remove();
							d3.select(".xaxis").remove();
							svg.selectAll(".score").remove();
							svg.selectAll(".arc1").remove();
							svg.selectAll(".race").remove();
							svg.selectAll(".program").remove();

							// program text
							let selected_program = this.value;
							svg.append("text")
								.text(function() {
									if (selected_program == "Meals") {
										return ("Program Type: Meal Pick-Ups")
									}
									else
									{
										return ("Program Type: Covid-19 Testing")
									}
								})
								.style("font-size", "18px")
								.attr("x", 20)
								.attr("fill", "white")
								.attr("font-family", "Lato Light")
								.attr("class", "program")
								.attr("y", 110);

							// shades of red (economic need index)
                            let color = d3.scaleQuantize()
								.range(["#FF7F7F","#FF0000","#BF0000","#800000","#400000"]);

							// Economic Need Index scale
							//color 1
							svg.append("rect")
								.attr("x", 20)
								.attr("y", 230)
								.attr("height", 12)
								.attr("width", 30)
								.attr("fill", "#FF7F7F")
							
							//color 2
							svg.append("rect")
								.attr("x", 50)
								.attr("y", 230)
								.attr("height", 12)
								.attr("width", 30)
								.attr("fill", "#FF0000")

							//color 3
							svg.append("rect")
								.attr("x", 80)
								.attr("y", 230)
								.attr("height", 12)
								.attr("width", 30)
								.attr("fill", "#BF0000")
							
							//color 4
							svg.append("rect")
								.attr("x", 110)
								.attr("y", 230)
								.attr("height", 12)
								.attr("width", 30)
								.attr("fill", "#800000")
							
							//color 5
							svg.append("rect")
								.attr("x", 140)
								.attr("y", 230)
								.attr("height", 12)
								.attr("width", 30)
								.attr("fill", "#400000")
							
							// economic need index scale labels
							svg.append("text")
								.text("LOW")
								.attr("font-family", "Lato")
                            	.style("fill", "white")
								.style("font-size", "12px")
								.attr("x", 20)
								.attr("y", 230);

							svg.append("text")
								.text("HIGH")
								.attr("font-family", "Lato")
                            	.style("fill", "white")
								.style("font-size", "12px")
								.attr("x", 140)
								.attr("y", 230);

							svg.append("text")
								.text("Economic Need Index")
								.attr("font-family", "Lato")
                            	.style("fill", "white")
								.style("font-size", "10px")
								.attr("x", 50)
								.attr("y", 252);

							// input domains for color scales
							color.domain([
								d3.min(data, (d)=> { return d.economic_need; }), 
								d3.max(data, (d)=> { return d.economic_need; })
							]);
							
							// Choropleth map for selected borough

							// SVG for filtered borough
							let svg2 = svg.append("svg")
								.style("stroke", "black")
								.style("stroke-width", "1px")
								.attr("width", 2000)
								.attr("heigh", 600);

							// filtered json array for selected borough
							var filtered = [];
                            
                            // find districts in selected borough
							for (let j = 0; j < json.features.length; j++) {

								let jsonDistrict = json.features[j].properties.schoolDistrict;
								// only get json objects for selected borough
                                if (selected_borough == "Manhattan"){
                                    if ((jsonDistrict >= 1) && (jsonDistrict <= 6)) {
                                        filtered.push(json.features[j])
                                    }
                                }

                                else if (selected_borough == "Bronx"){
                                    if ((jsonDistrict >= 7) && (jsonDistrict <= 12)) {
                                        filtered.push(json.features[j])
                                    }
                                }

                                else if (selected_borough == "Brooklyn"){
                                    if ((jsonDistrict >= 13) && (jsonDistrict <= 23)) {
                                        filtered.push(json.features[j])
                                    }
                                    else if (jsonDistrict == 32) {
                                        filtered.push(json.features[j])
                                    }
                                }

                                else if (selected_borough == "Queens"){
                                    if ((jsonDistrict >= 24) && (jsonDistrict <= 30)) {
                                        filtered.push(json.features[j])
                                    }
                                }

                                else if (selected_borough == "Staten Island"){
                                    if (jsonDistrict == 31) {
                                        filtered.push(json.features[j])
                                    }
                                }
                            }

							//Merge the csv data and GeoJSON
							//Loop through once for each csv data value
							for (let i = 0; i < data.length; i++) {
								let dataDistrict = data[i].district;

								//Find the corresponding zip code inside the GeoJSON
								for (let j = 0; j < json.features.length; j++) {
								
									let jsonDistrict = json.features[j].properties.schoolDistrict;
									if (dataDistrict == jsonDistrict) {
										//Copy the appropriate data value into the JSON
										json.features[j].properties.value = data[i].economic_need;
										json.features[j].properties.asian = data[i].asian;
										json.features[j].properties.black = data[i].black;
										json.features[j].properties.hispanic = data[i].hispanic;
										json.features[j].properties.multi_racial = data[i].multi_racial;
										json.features[j].properties.native_am = data[i].native_am;
										json.features[j].properties.white = data[i].white;
										
										//Stop looking through the JSON
										//break;
									}
								}	
							}

							//Define path generators per borough (changes in scale and translate coords)
                            queens_projection = d3.geoAlbers()
								.center([0, 40])
								.rotate([74,0])
								.translate([200, 1150])
								.scale(75000)

							let queens_path = d3.geoPath()
								.projection(queens_projection);

							let brooklyn_projection = d3.geoAlbers()
								.center([0, 40])
								.rotate([74,0])
								.translate([300, 1150])
								.scale(80000)

							let brooklyn_path = d3.geoPath()
								.projection(brooklyn_projection);

							let bronx_projection = d3.geoAlbers()
								.center([0, 40])
								.rotate([74,0])
								.translate([200, 1600])
								.scale(90000)

							let bronx_path = d3.geoPath()
								.projection(bronx_projection);

							let manhattan_projection = d3.geoAlbers()
								.center([0, 40])
								.rotate([74,0])
								.translate([300, 1450])
								.scale(90000)

							let manhattan_path = d3.geoPath()
								.projection(manhattan_projection);

							let staten_island_projection = d3.geoAlbers()
								.center([0, 40])
								.rotate([74,0])
								.translate([550, 1080])
								.scale(85000)

							let staten_path = d3.geoPath()
								.projection(staten_island_projection);

							var prev_district;
							var prev_color = "white";

							// function to add meal pick-up and testing site pins for selected borough
							// and generate charts for state exam results and racial makeup for selected district
							let vis = function(path, projection, low, high) {
								svg2.selectAll("path.a")
									.data(filtered)
									.enter()
									.append("path")
									.attr("d", path)
									.style("fill", (d)=> {
										//Get data value
										let value = d.properties.value;
										return color(value);
									})
									.attr("class", "a")
									// add district info
									.on("click", function(event, d){
										
										// change previously selected district to original color
										if (prev_district)
										{
											prev_district.style("fill", prev_color);
										};

										prev_district = d3.select(this);
										prev_color = d3.select(this).style("fill");

										// highlight selected district
       									d3.select(this).style("fill","#FFE4B5");

										d3.select(".district").remove();
										svg.selectAll(".ela_scores").remove();
										svg.selectAll(".math_scores").remove();

										d3.select(".yaxis").remove();
										d3.select(".xaxis").remove();

										svg.append("text")
											.attr("x", 880)
											.attr("y", 100)
											.style("text-anchor", "middle")
											.style("fill", "white")
											.attr("font-family", "Lato")
											.attr("stroke-width", "0.5px")
											.attr("stroke", "black")
											.style("font-size", "25px")
											.text("District " + d.properties.schoolDistrict)
											.attr("class", "district");

										ela_district_test_results = []
										math_district_test_results = []

										let yAxisSpace = 50; // space on the left for labeling y Axis
										let xAxisSpace = 100; // space on the bottom for labeling x Axis

										let xScale = d3.scaleBand()
											.domain(["Level 1", "Level 2", "Level 3", "Level 4"])
											.range([0, 240]);

										// set up scale for y axis
										let yScale = d3.scaleLinear()
											.domain([0, 100])
											.range([300, 100]);

										// set up functions to draw axes
										let yAxis = d3.axisLeft().scale(yScale);
										let xAxis = d3.axisBottom().scale(xScale);

										// draw axes (axes coordinates)
										svg.append("g")
											.attr("class", "yaxis")
											.attr("transform", "translate(" + ((550) + "," + (yAxisSpace)) + ")")
											.call(yAxis);

										svg.append("g")
											.attr("class", "xaxis")
											.attr("transform", "translate(550, " + (350) + ")")
											.call(xAxis);

										// ela test scores
										d3.csv("ELA_Test_Scores.csv", ela_test_Converter).then((ela_test)=> {

											for (let i = 0; i < ela_test.length; i++)
											{
												if (ela_test[i].district == d.properties.schoolDistrict)
												{
													if (ela_test[i].grade == "All Grades")
													{
														if (ela_test[i].year == 2019)
														{
															if (ela_test[i].category == "All Students")
															{
																//console.log(ela_test[i].level_1)
																ela_district_test_results.push(ela_test[i].level_1);
																ela_district_test_results.push(ela_test[i].level_2);
																ela_district_test_results.push(ela_test[i].level_3);
																ela_district_test_results.push(ela_test[i].level_4);
																//console.log(ela_test[i])
																break;

															}
														}
													}
												}
											}

										curr_district = d.properties.schoolDistrict;
										// bar chart rectangles
										svg.selectAll("rect.ela")
											.data(ela_district_test_results)
											.enter()
											.append("rect")
											.attr("x", function(d, i) {
												return (i * 60) + 550;
											})
											.attr("y", (d) => {
												return (yScale(d)) + yAxisSpace;
											})
											.attr("width", xScale.bandwidth()/3.5)
											.attr("height", function(d) {
												return 300 - yScale(d);
											})
											.attr("fill","#e9c087")
											.attr("class", "ela_scores")
											// hover values
											.on("mouseout", function(event, d){
												d3.select("#ela_value").attr("opacity", 0);
											})
											.on("mouseover", function(event, d){

												let x = parseInt(d3.select(this).attr("x"));
                                    			let y = parseInt(d3.select(this).attr("y"));
												d3.select("#ela_value").remove();
												
												svg.append("text")
													.attr("x", x)
													.attr("y", y)
													.style("text-anchor", "middle")
													.style("fill", "white")
													.attr("font-family", "Lato")
													.style("font-size", "12px")
													.text(d + "%")
													.attr("id", "ela_value");
											});
										});

										// math test scores
										d3.csv("Math_Test_Scores.csv", math_test_Converter).then((math_test)=> {
											for (let i = 0; i < math_test.length; i++)
											{
												if (math_test[i].district == d.properties.schoolDistrict)
												{
													if (math_test[i].grade == "All Grades")
													{
														if (math_test[i].year == 2019)
														{
															if (math_test[i].category == "All Students")
															{
																math_district_test_results.push(math_test[i].level_1);
																math_district_test_results.push(math_test[i].level_2);
																math_district_test_results.push(math_test[i].level_3);
																math_district_test_results.push(math_test[i].level_4);
																break;

															}
														}
													}
												}
											}

											curr_district = d.properties.schoolDistrict;
											// bar chart rectangles
											svg.selectAll("rect.math")
												.data(math_district_test_results)
												.enter()
												.append("rect")
												.attr("x", function(d, i) {
													return xScale.bandwidth()/3.5 + 0.5 + (i * 60) + 550;
												})
												.attr("y", (d) => {
													return (yScale(d)) + yAxisSpace;
												})
												.attr("width", xScale.bandwidth()/3.5)
												.attr("height", function(d) {
													return 300 - yScale(d);
												})
												.attr("fill","#488f31")
												.attr("class", "math_scores")
												// hover values
												.on("mouseout", function(event, d, i){
													d3.select("#math_value").attr("opacity", 0);
												})
												.on("mouseover", function(event, d){

													let x = parseInt(d3.select(this).attr("x"));
                            						let y = parseInt(d3.select(this).attr("y"));
													d3.select("#math_value").remove();
													
													svg.append("text")
														.attr("x", x)
														.attr("y", y)
														.style("text-anchor", "middle")
														.style("fill", "white")
														.attr("font-family", "Lato")
														.style("font-size", "13px")
														.text(d + "%")
														.attr("id", "math_value");
												});
										});

										// bar chart labels
										// ELA 
										svg.append("circle")
											.attr("cx", 580)
											.attr("cy", 390)
											.attr("r", 5)
											.attr("fill", "#e9c087")
											.attr("class", "score");

										svg.append("text")
											.attr("x", 600)
											.attr("y", 395)
											.style("text-anchor", "middle")
											.style("fill", "white")
											.attr("font-family", "Lato")
											.style("font-size", "12")
											.attr("class", "score")
											.text("ELA");

										// Math
										svg.append("circle")
											.attr("cx", 640)
											.attr("cy", 390)
											.attr("r", 5)
											.attr("class", "score")
											.attr("fill", "#488f31");

										svg.append("text")
											.attr("x", 663)
											.attr("y", 395)
											.style("text-anchor", "middle")
											.style("fill", "white")
											.attr("font-family", "Lato")
											.style("font-size", "12")
											.attr("class", "score")
											.text("Math");

										svg.append("text")
											.attr("x", 670)
											.attr("y", 140)
											.style("text-anchor", "middle")
											.style("fill", "white")
											.attr("font-family", "Lato")
											.style("font-size", "15")
											.attr("class", "score")
											.text("2019 NYS Test Score Percentages");

										// racial makeup donut chart
										let outerRadius = 100;
										let innerRadius = 50;
										let arc = d3.arc()
											.innerRadius(innerRadius)
											.outerRadius(outerRadius);
										
										let pie_colors = d3.scaleOrdinal(["#336660", "#5886a5", "#955196", "#dd5182", "#ff6e54", "#ffa600"]);
										
										var racial_makeup = {
											"Asian":d.properties.asian,
											"Black":d.properties.black,
											"Hispanic":d.properties.hispanic,
											"Multi":d.properties.multi_racial,
											"Native Am.":d.properties.native_am,
											"White":d.properties.white
										}

										var pie = d3.pie()
  											.value(function(d) {
												return d.value; 
											})

										var pie_data = Object.keys(racial_makeup)
											.map(function(d) { 
												return {key: d, value: racial_makeup[d]};
											});

										let arcs = svg.selectAll("g.arc")
											.data(pie(pie_data))
											.enter()
											.append("g")
											.attr("class", "arc1")
											.attr("transform", "translate(" + (outerRadius + 920) + "," + (250) + ")")
											.on("mouseout", function(event, d, i){
													d3.select("#race_value").attr("opacity", 0);
													d3.select("#race").attr("opacity", 0);
											})
											.on("mouseover", function(event, d, i){
												d3.select("#race").remove();

												svg.append("text")
													.attr("x", 850)
													.attr("y", 220)
													.style("text-anchor", "middle")
													.style("fill", "white")
													.attr("font-family", "Lato")
													.style("font-size", "14px")
													.text(d.data.key + ": " + Math.round(d.value * 100) + "%")
													.attr("id", "race");

											});
								
										//Draw arc paths
										arcs.append("path")
											.attr("fill", (d, i)=> {
												return pie_colors(i);
											})
											.attr("d", arc);
										
										// donut chart labels
										svg.append("circle")
											.attr("cx", 840)
											.attr("cy", 250)
											.attr("r", 5)
											.attr("fill", "#336660")
											.attr("class", "race");

										svg.append("text")
											.attr("x", 865)
											.attr("y", 253)
											.style("text-anchor", "middle")
											.style("fill", "white")
											.attr("font-family", "Lato")
											.style("font-size", "12")
											.attr("class", "race")
											.text("Asian");

										svg.append("circle")
											.attr("cx", 840)
											.attr("cy", 270)
											.attr("r", 5)
											.attr("fill", "#5886a5")
											.attr("class", "race");

										svg.append("text")
											.attr("x", 865)
											.attr("y", 273)
											.style("text-anchor", "middle")
											.style("fill", "white")
											.attr("font-family", "Lato")
											.style("font-size", "12")
											.attr("class", "race")
											.text("Black");

										svg.append("circle")
											.attr("cx", 840)
											.attr("cy", 290)
											.attr("r", 5)
											.attr("fill", "#955196")
											.attr("class", "race");

										svg.append("text")
											.attr("x", 873)
											.attr("y", 293)
											.style("text-anchor", "middle")
											.style("fill", "white")
											.attr("font-family", "Lato")
											.style("font-size", "12")
											.attr("class", "race")
											.text("Hispanic");

										svg.append("circle")
											.attr("cx", 840)
											.attr("cy", 310)
											.attr("r", 5)
											.attr("fill", "#dd5182")
											.attr("class", "race");

										svg.append("text")
											.attr("x", 863)
											.attr("y", 315)
											.style("text-anchor", "middle")
											.style("fill", "white")
											.attr("font-family", "Lato")
											.style("font-size", "12")
											.attr("class", "race")
											.text("Multi");

										svg.append("circle")
											.attr("cx", 840)
											.attr("cy", 330)
											.attr("r", 5)
											.attr("fill", "#ff6e54")
											.attr("class", "race");

										svg.append("text")
											.attr("x", 880)
											.attr("y", 333)
											.style("text-anchor", "middle")
											.style("fill", "white")
											.attr("font-family", "Lato")
											.style("font-size", "12")
											.attr("class", "race")
											.text("Native Am.");

										svg.append("circle")
											.attr("cx", 840)
											.attr("cy", 350)
											.attr("r", 5)
											.attr("fill", "#ffa600")
											.attr("class", "race");

										svg.append("text")
											.attr("x", 865)
											.attr("y", 355)
											.style("text-anchor", "middle")
											.style("fill", "white")
											.attr("font-family", "Lato")
											.style("font-size", "12")
											.attr("class", "race")
											.text("White");

										svg.append("text")
											.attr("x", 1020)
											.attr("y", 130)
											.style("text-anchor", "middle")
											.style("fill", "white")
											.attr("font-family", "Lato")
											.style("font-size", "15")
											.attr("class", "race")
											.text("Racial Makeup");
									});


									// meal locations in selected borough
									if (selected_program == "Meals") {
										d3.csv("COVID-19_Free_Meals_Locations.csv", mealConverter).then((meal_sites)=> {
											
											// filter for meals based on district
											meal_locations = []
											for (let k = 0; k < meal_sites.length; k++) {
												if ((meal_sites[k].district >= low) && (meal_sites[k].district <= high)) {
													if ((!Number.isNaN(meal_sites[k].lat)) && (!Number.isNaN(meal_sites[k].lon)) ) {
														meal_locations.push(meal_sites[k]);
													}
												}
											}

											// add meal pick-up location pins to map
											svg.selectAll(".meal_location")
												.data(meal_locations)
												.enter()
												.append("image")
												.attr('class', 'meal_sites_pin')
												.attr('width', 15)
												.attr('height', 15)
												.attr("opacity", 5)
												.attr("xlink:href", 'pin.png')
												.attr("transform", function(d) {
													return "translate(" + projection([d.lon, d.lat]) + ")";
												})
												// pin location
												.on("mouseout", function(event, d){
													d3.select("#meal_sf").attr("opacity", 0);
												})
												.on("mouseover", function(event, d){
													d3.select("#meal_sf").remove();
													
													svg.append("text")
														.attr("x", 500)
														.attr("y", 80)
														.style("text-anchor", "middle")
														.style("fill", "white")
														.attr("font-family", "Lato")
														.style("font-size", "14px")
														.text(d.school)
														.attr("id", "meal_sf");
												});
											})
										}
									
									// test site locations
									else if (selected_program == "Tests") {
										d3.csv("Testing_Sites.csv", test_Converter).then((test_sites)=> {
											// filter for test sites based on district
											test_locations = []

											// sites with findable addresses
											findable_test_sites = [];

											// get lat and lon for all schools
											d3.csv("School_Locations.csv", school_locations_Converter).then((schools)=> {
												for (let i = 0; i < test_sites.length; i++)
												{
													for (let j = 0; j < schools.length; j++)
													{
														if ((test_sites[i].school_name == schools[j].school_name)
															&& (test_sites[i].district == schools[j].district))
														{
															test_sites[i].lat = schools[j].lat;
															test_sites[i].lon = schools[j].lon;
															findable_test_sites.push(test_sites[i])
															break;
														}
													}
												}

												for (let k = 0; k < findable_test_sites.length; k++) {
													if ((findable_test_sites[k].district >= low) && (findable_test_sites[k].district <= high)) {
														if ((!Number.isNaN(findable_test_sites[k].lat)) && (!Number.isNaN(findable_test_sites[k].lon)) ) {
															console.log(findable_test_sites[k].school_name, findable_test_sites[k].lat, findable_test_sites[k].lon);
															test_locations.push(findable_test_sites[k]);
														}
													}
												}

												// add testing site pins to map
												svg.selectAll(".test_location")
													.data(test_locations)
													.enter()
													.append("image")
													.attr('class', 'testing_sites_pin')
													.attr('width', 10)
													.attr('height', 10)
													.attr("opacity", 5)
													.attr("xlink:href", 'pin.png')
													.attr("transform", function(d) {
														return "translate(" + projection([d.lon, d.lat]) + ")";
													})
													// pin location
													.on("mouseout", function(event, d){
														d3.select("#test_name").attr("opacity", 0);
													})
													.on("mouseover", function(event, d){
														d3.select("#test_name").remove();
														
														svg.append("text")
															.attr("x", 550)
															.attr("y", 80)
															.style("text-anchor", "middle")
															.style("fill", "white")
															.attr("font-family", "Lato")
															.style("font-size", "14px")
															.text(d.school_name)
															.attr("id", "test_name");
													});

												});
											})
										};
									}
							
							// call vis function for all boroughs
							if (selected_borough == "Queens")
							{
								vis(queens_path, queens_projection, 24, 30);
							}

							else if (selected_borough == "Brooklyn")
							{
								vis(brooklyn_path, brooklyn_projection, 13, 23);
							}

							else if (selected_borough == "Bronx")
							{
								vis(bronx_path, bronx_projection, 7, 12);
							}

							else if (selected_borough == "Manhattan")
							{
                                vis(manhattan_path, manhattan_projection, 1, 6);
							}

							else if (selected_borough == "Staten Island")
							{
                                vis(staten_path, staten_island_projection, 31, 31);
							}

							// Choropleth map for all boroughs
							// SVG for minimized city overview
							let svg3 = svg.append("svg")
								.attr("stroke", "gray")
								.attr("stroke-width", "0.5px")
								.attr("width", 250)
								.attr("heigh", 250);

							// Define map projection
							let projection = d3.geoAlbers()
								.center([0, 40])
								.rotate([74,0])
								.translate([100, 660])
								.scale(25000);

							// Define path generator for all boroughs
							let path = d3.geoPath()
								.projection(projection);

							// Bind data and create one path per GeoJSON feature
							svg3.selectAll("path")
							.data(json.features)
							.enter()
							.append("path")
							.attr("d", path)
							.style("fill", (d)=> {
								//Get data value
								let value = d.properties.value;
								return color(value);
							})

							svg3.append('rect')
								.attr('x', 10)
								.attr('y', 210)
								.attr('width', 200)
								.attr('height', 240)
								.attr("fill", "none")
								.attr("stroke", "white")
								.attr("stroke-width", "1px");
						})
					});

				});
			});
		</script>
	</body>
</html>